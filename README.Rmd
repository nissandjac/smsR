---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# smsR

<!-- badges: start -->
<!-- badges: end -->

smsR is a seasonal stock assessment model package using TMB to estimate parameters. The model is the current assessment model for sandeel (4 stocks) and sprat in the North Sea. 

## Installation

You can install the development version of smsR as

``` {r, eval= FALSE}
remotes::install_github("nissandjac/smsR",
  ref = "main",            # Install main branch
  dependencies = TRUE,     # Installs Imports/Suggests
  upgrade = "never")       # don't upgrade already-installed deps
```

## Using the model

The model can be run with the provided data set `sandeel_1r` and the Sandeel 1r standard configuration as 

```{r example}
library(smsR)


# Set up sandeel for area 1r

df.tmb <- get_TMB_parameters(
  mtrx = sandeel_1r$lhs, # List that contains M, mat, west, weca
  Surveyobs = sandeel_1r$survey, # Survey observations
  Catchobs = sandeel_1r$Catch, # Catch observations
  years = 1983:2021, # Years to run
  nseason = 2, # Number of seasons
  useEffort = TRUE, # Use effort to calculate F
  ages = 0:4, # Ages of the species
  recseason = 2, # Season where recruitment occurs
  CminageSeason = c(1, 1), # Minimum catch age per season
  Fmaxage = 3, # Fully selected fishing mortality age
  Qminage = c(0, 1), # Minimum age in surveys
  Qmaxage = c(1, 3), # Max age in surveys
  Fbarage = c(1, 2), # Age use to calculate Fbar
  effort = sandeel_1r$effort, # Effort input
  blocks = c(1983, 1999), # Blocks with unique selectivity
  nocatch = sandeel_1r$nocatch, # Seasons where F is not calculated
  surveyStart = c(0.75, 0), #
  surveyEnd = c(1, 0), #
  surveySeason = c(2, 1), #
  surveySD = list(c(0, 1), c(1, 2)),
  catchSD = list(c(1, 3), c(1, 3)), # Catch CV groupings
  estSD = c(0, 2, 0), # Estimate CVs for 1) survey, 2) catch, 3) Stock recruitment relationship
  beta = 105809, # Hockey stick break point
  nllfactor = c(1, 1, 0.05) # Factor for relative strength of log-likelihood
)


parms <- getParms(df.tmb)

sas <- runAssessment(df.tmb, parms)
```



<!-- You'll still need to render `README.Rmd` regularly, to keep `README.md` up-to-date. `devtools::build_readme()` is handy for this. -->

The resulting fit to the data can then be visualized in a summary output showing SSB, Catch, recruitment and Fbar as 

```{r, echo = TRUE}
plot(sas, printFig = FALSE)
```


Or to evaluate the retrospective patterns as 

```{r, echo = TRUE, warning=FALSE, message=FALSE}
mr <- mohns_rho(df.tmb, peels = 5, parms = parms, plotfigure = FALSE)

mr$p1()
```

## Simulating data 
*smsR* includes a range of functions to simulate data. Here is an example of a simple model with Beverton Holt as the stock recruitment relationship. Here two essential functions are used $sim_OM_parameters()$ and $run.agebased.sms.op()$. See ?$sim_OM_parameters()$ for default values that are used when unspecified. 

```{r}

# Define the number of seasons and number of years 
nseason <- 2
nyear <- 30

# Model fishing mortality with contrast to ensure parity in parameter estimation 
Fin <- matrix(c(seq(0.1,0.5,length.out = 15),seq(0.5,0.1,length.out = 15)),
                nyear,
                nseason)
# Initiate a list of parameters for an operating model. Note that parameters from a generic stock are used per default for selectivity, maturity, recruitment etc. 

dat <- sim_OM_parameters(nseason = nseason,
                           nyear = nyear,
                           F0 = Fin,
                           M = .3, # natural mortality 
                           Fpast = .2, # Fishing mortality before simulation starts 
                           maxage = 5, # Maximum age 
                           recruitment = 'BH_steep' # Stock recruitment function 
                         )

# Run the operating model 
OM <- run.agebased.sms.op(dat)

```


We can then turn this 

```{r}
# Required data to fit
Surveyobs <- OM$survey
Catchobs <- OM$Catchobs

# Most simple model
mtrx <- list(weca = dat$weca, west = dat$west, mat = dat$mat, M = dat$M)

df.tmb <- get_TMB_parameters(mtrx,
                             Surveyobs, # From a simulated model
                             Catchobs, # From a simulated model
                             years = 1:nyear,
                             nseason = dat$nseason,
                             ages= 0:5,
                             recmodel = 3#,
                             #randomR = 1
)


parms <- getParms(df.tmb)

#parms$logbeta <- 1e-5
mps <- getMPS(df.tmb, parms)
sas <- runAssessment(df.tmb, parms , mps = mps , debug = TRUE)
# See if Fmsy works
plot(sas)


# Get Fsmy
getFmsy(sas, recruitment = 'BH_steep')


```


## Random effects 
Since the model runs in TMB, it is possible to estimate some parameters as random effects, specifically time varying natural mortality, recruitment, and fishing mortality. The model currently does not 




